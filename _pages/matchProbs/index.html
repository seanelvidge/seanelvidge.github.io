<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p>&lt;!DOCTYPE html&gt;</p> <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script> <script src="https://d3js.org/d3.v7.min.js"></script> <style>:root{--text-color:#111;--muted-text-color:#333}@media(prefers-color-scheme:dark){:root{--text-color:#eee;--muted-text-color:#ccc}}.chart-container svg text{fill:var(--text-color)}.chart-container svg text.bar-label{fill:var(--muted-text-color)}.btn{display:inline-block;margin:6px 8px 0 0;padding:8px 12px;border:0;border-radius:4px;background-color:#008cba;color:#fff;font-size:14px;cursor:pointer}.btn:hover{background-color:#007ba1}form{margin-bottom:20px}label{margin-right:10px;font-weight:bold}input[type="text"],input[type="number"],select{padding:4px 6px;font-size:14px;margin-right:8px}.warning{color:#c00;font-weight:bold;margin:10px auto;max-width:600px}.teams-row{text-align:center;margin-bottom:20px;flex-wrap:wrap}.team-container{display:inline-block;width:20%;text-align:center;vertical-align:middle;min-width:150px}.team-name{font-size:1.2em;font-weight:bold;text-align:center;margin-top:5px}.team-rank{font-size:1em;text-align:center;margin-top:2px;opacity:.9}.vs-label{display:none;margin:0 5px;font-size:2em;font-weight:bold;vertical-align:middle}.chart-container{display:flex;justify-content:center;max-width:900px;margin:0 auto 2px auto}.chart-container svg{width:100%;height:auto;display:block;overflow:visible}.bar-label{font-weight:bold}@media(max-width:600px){form#probForm{display:flex;flex-direction:column;align-items:flex-start}form#probForm label,form#probForm input,form#probForm select{display:block;margin:8px 0}.button-row{display:flex;flex-direction:row;justify-content:center;width:100%;margin-top:10px}.teams-row{display:flex;flex-direction:column;align-items:center}.team-container{width:100%;margin-bottom:10px}.vs-label{margin-bottom:10px}}</style> <form id="probForm"> <label for="team1Input">Team #1 (Home):</label> <input type="text" id="team1Input" list="teams"> <label for="team2Input">Team #2 (Away):</label> <input type="text" id="team2Input" list="teams"> <datalist id="teams"></datalist> <br><br> <div class="button-row"> <button type="submit" class="btn">Compute</button> <button type="button" id="resetButton" class="btn">Reset</button> </div> </form> <div id="warningMessage" class="warning" style="display:none;"></div> <div id="shareLink" style="display:none; margin: 10px 0; font-weight: bold;"></div> <div class="teams-row"> <div class="team-container" id="team1Container"> <div class="team-name" id="team1Name"></div> <div class="team-rank" id="team1Rank"></div> </div> <div class="vs-label" id="vsLabel">vs</div> <div class="team-container" id="team2Container"> <div class="team-name" id="team2Name"></div> <div class="team-rank" id="team2Rank"></div> </div> </div> <div class="chart-container" id="chart"></div> <script>function getURLParameter(e){return new URLSearchParams(window.location.search).get(e)||""}function editDistance(e,t){e=e.toLowerCase(),t=t.toLowerCase();const a=[];for(let t=0;t<=e.length;t++)a[t]=[t];for(let e=0;e<=t.length;e++)a[0][e]=e;for(let n=1;n<=e.length;n++)for(let o=1;o<=t.length;o++)e.charAt(n-1)===t.charAt(o-1)?a[n][o]=a[n-1][o-1]:a[n][o]=1+Math.min(a[n-1][o],a[n][o-1],a[n-1][o-1]);return a[e.length][t.length]}function getClosestTeamName(e,t){if(!e)return"";const a=e.toLowerCase(),n=t.find(e=>e.toLowerCase()===a);if(n)return n;const o=t.filter(e=>e.toLowerCase().includes(a)),l=o.length?o:t;let r="",s=1/0;return l.forEach(t=>{const a=editDistance(t,e);a<s&&(s=a,r=t)}),r}function clamp(e,t,a){return Math.max(t,Math.min(a,e))}function safe_probs(e,t=.001){let a=e.map(e=>clamp(e,t,1-t));const n=a.reduce((e,t)=>e+t,0);return a.map(e=>e/n)}function elo_to_skill(e,t=.9,a=1e3,n=2,o=0){return(e-a)/(ELO_PER_NAT_LOGIT*t*n)+o}function era_probs_from_year(e){const t=-.141579*(e-1888)+60.5636,a=.075714*(e-1888)+19.4769,n=.065851*(e-1888)+19.9608;let o=Math.max(t,.001),l=Math.max(n,.001),r=Math.max(a,.001);const s=o+l+r;return o/=s,l/=s,r/=s,{pH:o,pA:r,pD:l}}function delta_base_and_kappa(e){const{pH:t,pA:a,pD:n}=era_probs_from_year(e),o=.5*Math.log(t/a);return{Delta_base:o,kappa:n/(1-n)*2*Math.cosh(o)}}function predict_probs(e,t,a,n=1){const{Delta_base:o,kappa:l}=delta_base_and_kappa(a),r=n*(e-t)+o,s=Math.exp(r),i=Math.exp(-r),m=s+i+l;return[s/m,l/m,i/m]}function probabilities(e,t,a,n=.9){const o=.997,l=[o*elo_to_skill(e,n)+(1-o),o*elo_to_skill(t,n)+(1-o)];let r=predict_probs(l[0],l[1],a,n);return r=safe_probs(r,.001),r}function renderProbChart(e){const t=[{label:"Home Win",value:e[0]},{label:"Draw",value:e[1]},{label:"Away Win",value:e[2]}];d3.select("#chart").selectAll("*").remove();const a={top:10,right:30,bottom:10,left:90},n=800,o=160,l=n-a.left-a.right,r=26,s=18,i=d3.select("#chart").append("svg").attr("viewBox",`0 0 ${n} ${o}`).attr("preserveAspectRatio","xMidYMid meet").append("g").attr("transform",`translate(${a.left}, ${a.top})`),m=d3.scaleLinear().domain([0,1]).range([0,l]);t.forEach((e,t)=>{const a=t*(r+s);i.append("text").attr("x",m(e.value)+6).attr("y",a+r/1.6).attr("class","bar-percent").text((100*e.value).toFixed(1)+"%"),i.append("rect").attr("x",0).attr("y",a).attr("width",m(e.value)).attr("height",r).attr("fill",0===t?"#599ad3":1===t?"#9e9e9e":"#d3635a"),i.append("text").attr("x",m(e.value)+6).attr("y",a+r/1.6).text((100*e.value).toFixed(1)+"%")})}function toDateSafe(e){const t=new Date(e);return isNaN(t.getTime())?new Date(0):t}function buildLatestRanks(e){const t={};return e.forEach(e=>{const a=toDateSafe(e.Date),n=e.HomeTeam,o=e.AwayTeam,l=parseFloat(e.HomeRank_after),r=parseFloat(e.AwayRank_after);n&&!isNaN(l)&&(!t[n]||a>=t[n].date)&&(t[n]={date:a,elo:l}),o&&!isNaN(r)&&(!t[o]||a>=t[o].date)&&(t[o]={date:a,elo:r})}),t}const ELO_PER_NAT_LOGIT=400/Math.log(10),csvUrl="https://raw.githubusercontent.com/seanelvidge/England-football-results/refs/heads/main/experimental/EnglandLeagueResults_wRanks.csv";let allMatches=[],allTeams=[],latestRanks={};d3.csv(csvUrl).then(e=>{allMatches=e;const t=new Set;e.forEach(e=>{t.add(e.HomeTeam),t.add(e.AwayTeam)}),allTeams=Array.from(t).filter(Boolean).sort();const a=document.getElementById("teams");allTeams.forEach(e=>{const t=document.createElement("option");t.value=e,a.appendChild(t)}),latestRanks=buildLatestRanks(e);const n=getURLParameter("team1"),o=getURLParameter("team2");n&&(document.getElementById("team1Input").value=getClosestTeamName(n,allTeams)),o&&(document.getElementById("team2Input").value=getClosestTeamName(o,allTeams)),(n||o)&&document.querySelector('#probForm button[type="submit"]').click()}),document.getElementById("probForm").addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("team1Input").value.trim(),a=document.getElementById("team2Input").value.trim(),n=(new Date).getFullYear(),o=document.getElementById("warningMessage");o.style.display="none",o.textContent="";let l=allTeams.includes(t)?t:getClosestTeamName(t,allTeams),r=allTeams.includes(a)?a:getClosestTeamName(a,allTeams);if(!l)return o.textContent="Unknown team name: "+t,void(o.style.display="block");if(!r)return o.textContent="Unknown team name: "+a,void(o.style.display="block");if(!n||isNaN(n))return o.textContent="Please enter a valid year.",void(o.style.display="block");const s=latestRanks[l]?.elo,i=latestRanks[r]?.elo;if(null==s)return o.textContent="No ranking found for "+l,void(o.style.display="block");if(null==i)return o.textContent="No ranking found for "+r,void(o.style.display="block");document.getElementById("team1Name").textContent=l,document.getElementById("team2Name").textContent=r,document.getElementById("team1Rank").textContent="Latest rating: "+s.toFixed(0),document.getElementById("team2Rank").textContent="Latest rating: "+i.toFixed(0),document.getElementById("vsLabel").style.display="inline-block";renderProbChart(probabilities(s,i,n));const m=`${"https://seanelvidge.com/matchProbs"}?team1=${encodeURIComponent(l)}&team2=${encodeURIComponent(r)}`,c=document.getElementById("shareLink");c.style.display="block",c.innerHTML=`<a href="${m}" target="_blank" rel="noopener">URL link for this probability query</a><br><br>`}),document.getElementById("resetButton").addEventListener("click",()=>{window.location.search="",window.location.reload()});</script> <p>&lt;/html&gt;</p> </body></html>