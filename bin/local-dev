#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

if [ -d "$HOME/.rbenv" ]; then
  export PATH="$HOME/.rbenv/bin:$PATH"
  if command -v rbenv >/dev/null 2>&1; then
    # Ensure rbenv shims are active in non-interactive shells.
    eval "$(rbenv init -)"
  fi
fi

if command -v g++-11 >/dev/null 2>&1; then
  export CC=gcc-11
  export CXX=g++-11
elif command -v g++-10 >/dev/null 2>&1; then
  export CC=gcc-10
  export CXX=g++-10
fi

if [ -d ".venv" ]; then
  # shellcheck source=/dev/null
  source ".venv/bin/activate"
else
  python3 -m venv .venv
  # shellcheck source=/dev/null
  source ".venv/bin/activate"
fi

python -m pip install --upgrade pip
if [ -f "requirements-dev.txt" ]; then
  pip install -r requirements-dev.txt
fi

if ! command -v bundle >/dev/null 2>&1; then
  if ! command -v ruby >/dev/null 2>&1; then
    echo "Ruby not found. Install Ruby (>= 2.7) and Bundler, then re-run this script." >&2
    exit 1
  fi

  ruby_version="$(ruby -e 'print RUBY_VERSION' 2>/dev/null || true)"
  version_ge() {
    [ "$(printf '%s\n' "$2" "$1" | sort -V | head -n1)" = "$2" ]
  }

  if [ -n "$ruby_version" ] && ! version_ge "$ruby_version" "3.2.0"; then
    echo "Ruby $ruby_version detected; installing Bundler 2.4.22 for compatibility."
    gem install bundler -v 2.4.22
  else
    gem install bundler
  fi
fi

if [ -f "$ROOT_DIR/Gemfile.local" ]; then
  export BUNDLE_GEMFILE="$ROOT_DIR/Gemfile.local"
fi

bundle install
bundle exec jekyll serve --livereload
